<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Chat</title>
    <style>
      /* #chats {
          border: 2px solid red;
          width: 50%;
          height: 10%;
          overflow: scroll;
      } */
    </style>

    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>

    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=delete"
    />
  </head>

  <body>
    <!-- <div id="message">
    <p id="msg"></p>
</div> -->

    <div id="chats"></div>

    <label for="user-name">Name</label
    ><input
      type="text"
      name="user-name"
      id="user-name"
      value=""
      placeholder="Name"
    />
    <label for="user-text">Message</label
    ><input
      type="text"
      name="user-text"
      id="user-text"
      value=""
      placeholder="message"
    />
    <button id="btn">send</button>

    <script type="module">
      const firebaseConfig = {
        apiKey: "AIzaSyD57N2Ewp8UVtcXKmVMFyP1HeTBksh4iww",
        authDomain: "my-project-9714d.firebaseapp.com",
        databaseURL: "https://my-project-9714d-default-rtdb.firebaseio.com",
        projectId: "my-project-9714d",
        storageBucket: "my-project-9714d.firebasestorage.app",
        messagingSenderId: "84976519917",
        appId: "1:84976519917:web:1294f53b957c48e38f5ae4",
      };

      firebase.initializeApp(firebaseConfig);

      let btn = document.getElementById("btn");
      let para = document.getElementById("msg");

      async function addMsg(name, text) {
        try {
          let result = await firebase
            .firestore()
            .collection("chat")
            .add({ name, text });

          if (result) {
            console.log("document added!");
          }
        } catch (e) {
          console.log(e);
        }
      }

      btn.addEventListener("click", () => {
        console.log("clicked");

        let name = document.getElementById("user-name").value || "Guest";
        let text = document.getElementById("user-text").value;

        // ifEXists -> meta.data-> uid, data -> key & values
        let ifExists = false;

        if (ifExists) {
            updateMsg();
        } else {
            addMsg(name, text);
        }

        document.getElementById("user-name").value = "";
        document.getElementById("user-text").value = "";
      });

      function getMsg() {
        firebase
          .firestore()
          .collection("chat")
          .onSnapshot((changes) => {
            changes.docChanges().forEach((change) => {
              if (change.type === "added") {
                //para.innerText += `${change.doc.data().name}: ${change.doc.data().text}\n`;
                let pElement = document.createElement("p"); // creating new p tag
                pElement.setAttribute("id", change.doc.id);
                pElement.innerText = `${change.doc.data().name}:${
                  change.doc.data().text
                }`;

                // delete button
                let delBtn = document.createElement("button"); // creating new delete button
                delBtn.innerText = "Delete Msg";

                //update button
                let updateButton = document.createElement("button");
                updateButton.innerText = "Update Msg";

                //get the div
                let chatContainer = document.getElementById("chats");
                // append to div
                chatContainer.appendChild(pElement);
                chatContainer.appendChild(delBtn);
                chatContainer.appendChild(updateButton);

                updateButton.onclick = () => {
                  // get the element -> inner Text

                  let [name, text] = pElement.innerText.split(":");
                  console.log(`name is ${name} & text is ${text}`);

                  document.getElementById("user-name").value = name;
                  document.getElementById("user-text").value = text;

                  function updateMsg(docId, name, text) {}
                };

                delBtn.onclick = () => deleteMsg(change.doc.id);
              } else if (change.type === "removed") {
                document.getElementById(change.doc.id).remove();
                document.getElementById("").remove();
                // remove the delete button
                document.getElementById(`${change.doc.id}-delBtn`)?.remove();

                // remove the update button
                document.getElementById(`${change.doc.id}-updateBtn`)?.remove();
              }
            });
          });
      }

      function deleteMsg(docID) {
        try {
          console.log("delete msg function");
          let delete_fun = firebase
            .firestore()
            .collection("chat")
            .doc(docID)
            .delete();
          if (delete_fun) {
            console.log(delete_fun);
          }
        } catch {
          console.log(Error);
        }
      }

      getMsg();
    </script>
  </body>
</html>
